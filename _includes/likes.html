<!-- Подключаем Supabase SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

<!-- Компоненты лайков -->
<div class="like-container">
    <button id="like-button" class="like-button">❤️ Поставить лайк</button>
    <p>Количество лайков: <span id="like-count">0</span></p>
    <p id="status-message" style="color: gray; font-size: 0.9em;"></p>
</div>

<script>
    (function () {
        // Инициализация Supabase клиента
        const supabaseUrl = 'https://ysoyybfvdpfcbjvbnocc.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlzb3l5YmZ2ZHBmY2JqdmJub2NjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzIzODQ3MzYsImV4cCI6MjA0Nzk2MDczNn0.2lVwjfYdRqKNz1tfuIA3hcRTyml3OIohKuC6AL677MM';
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);

        // Тестовый идентификатор страницы
        const pageId = 'test-page';

        // Ссылки на элементы
        const likeButton = document.getElementById('like-button');
        const likeCountElement = document.getElementById('like-count');
        const statusMessage = document.getElementById('status-message');

        // Проверка наличия всех элементов
        if (!likeButton || !likeCountElement || !statusMessage) {
            console.error('Не все элементы для работы скрипта найдены.');
            return;
        }

        // Функция для отображения сообщения о статусе
        function setStatusMessage(message, isError = false) {
            statusMessage.textContent = message;
            statusMessage.style.color = isError ? 'red' : 'gray';
        }

        // Функция увеличения лайков
        async function likePage() {
            likeButton.disabled = true; // Отключаем кнопку во время запроса
            setStatusMessage('Обновляем лайки...');

            try {
                const { data, error: fetchError } = await supabase
                    .from('likes')
                    .select('count')
                    .eq('page_id', pageId)
                    .single();

                if (fetchError && fetchError.code !== 'PGRST116') {
                    console.error('Ошибка при получении записи:', fetchError);
                    setStatusMessage('Ошибка при загрузке данных.', true);
                    return;
                }

                if (!data) {
                    const { error: insertError } = await supabase
                        .from('likes')
                        .insert({ page_id: pageId, count: 1 });

                    if (insertError) {
                        console.error('Ошибка при создании записи:', insertError);
                        setStatusMessage('Ошибка при создании записи.', true);
                        return;
                    }
                } else {
                    const { error: updateError } = await supabase
                        .from('likes')
                        .update({ count: data.count + 1 })
                        .eq('page_id', pageId);

                    if (updateError) {
                        console.error('Ошибка при обновлении лайков:', updateError);
                        setStatusMessage('Ошибка при обновлении лайков.', true);
                        return;
                    }
                }

                setStatusMessage('Лайки успешно обновлены!');
                await updateLikes();
            } catch (error) {
                console.error('Произошла ошибка:', error);
                setStatusMessage('Непредвиденная ошибка.', true);
            } finally {
                likeButton.disabled = false; // Включаем кнопку
            }
        }

        // Функция обновления количества лайков
        async function updateLikes() {
            setStatusMessage('Загружаем количество лайков...');
            try {
                const { data, error } = await supabase
                    .from('likes')
                    .select('count')
                    .eq('page_id', pageId)
                    .single();

                if (error) {
                    console.error('Ошибка при получении количества лайков:', error);
                    setStatusMessage('Ошибка при загрузке лайков.', true);
                } else if (data) {
                    likeCountElement.textContent = data.count || 0;
                    setStatusMessage('Количество лайков загружено.');
                }
            } catch (error) {
                console.error('Произошла ошибка при обновлении лайков:', error);
                setStatusMessage('Ошибка при загрузке данных.', true);
            }
        }

        // Устанавливаем обработчики событий
        document.addEventListener('DOMContentLoaded', () => {
            likeButton.addEventListener('click', likePage);
            updateLikes();
        });
    })();
</script>
